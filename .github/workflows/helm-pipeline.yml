name: Helm CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
    paths: [ "charts/**" ]

env:
  CHART_NAME: my-app
  CHART_PATH: charts/my-app
  OCI_REGISTRY: ghcr.io
  OCI_REPO: ghcr.io/${{ github.repository }}/my-app
  HELM_VERSION: v3.14.0

jobs:
  helm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Helm Lint
        run: helm lint $CHART_PATH

      - name: Set version from Git tag or commit
        run: |
          VERSION=${GITHUB_SHA::7}
          sed -i "s/^version:.*/version: ${VERSION}/" $CHART_PATH/Chart.yaml

      - name: Package Helm Chart
        run: |
          mkdir -p release
          helm package $CHART_PATH --destination release

      # =======================
      # Publish to GitHub Pages
      # =======================
      - name: Publish Helm Repo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git fetch
          git checkout --orphan gh-pages || git checkout gh-pages

          mkdir -p charts
          cp release/*.tgz charts/

          helm repo index charts --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts

          git add .
          git commit -m "Helm release"
          git push origin gh-pages --force

      # =======================
      # Push to OCI (GHCR)
      # =======================
      - name: Login to GHCR
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push Helm Chart to OCI
        run: |
          helm push release/*.tgz oci://${OCI_REPO}
